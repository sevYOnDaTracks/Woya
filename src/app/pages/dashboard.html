<div class="onboarding-backdrop" *ngIf="requireProfileModal">
  <div class="onboarding-modal" role="dialog" aria-modal="true" aria-labelledby="onboardingTitle">
    <div class="onboarding-modal__header">
      <p class="onboarding-modal__eyebrow">Premiers pas</p>
      <h2 id="onboardingTitle">Complète ton profil</h2>
      <p>Ces informations sont nécessaires pour sécuriser ton compte et faciliter les échanges.</p>
    </div>

    <form class="onboarding-modal__form" (ngSubmit)="saveProfileModal()">
      <div class="onboarding-modal__grid">
        <label class="onboarding-field">
          <span>Pseudo *</span>
          <input
            type="text"
            name="pseudo"
            maxlength="40"
            required
            [(ngModel)]="profileModalForm.pseudo"
            (ngModelChange)="onProfileModalPseudoChange($event)"
          />
          <small class="onboarding-field__hint" *ngIf="profilePseudoStatus !== 'idle'">
            <ng-container [ngSwitch]="profilePseudoStatus">
              <span *ngSwitchCase="'checking'">Vérification du pseudo…</span>
              <span *ngSwitchCase="'available'" class="text-emerald-600">Pseudo disponible.</span>
              <span *ngSwitchCase="'taken'" class="text-red-600">Ce pseudo est déjà utilisé.</span>
              <span *ngSwitchCase="'error'" class="text-orange-600">Impossible de vérifier le pseudo.</span>
            </ng-container>
          </small>
        </label>

        <label class="onboarding-field">
          <span>Nom *</span>
          <input type="text" name="lastname" maxlength="60" required [(ngModel)]="profileModalForm.lastname" />
        </label>

        <label class="onboarding-field">
          <span>Prénom *</span>
          <input type="text" name="firstname" maxlength="60" required [(ngModel)]="profileModalForm.firstname" />
        </label>

        <label class="onboarding-field">
          <span>Téléphone *</span>
          <input type="text" name="phone" maxlength="30" required [(ngModel)]="profileModalForm.phone" />
        </label>

        <label class="onboarding-field">
          <span>Ville *</span>
          <input type="text" name="city" maxlength="80" required [(ngModel)]="profileModalForm.city" />
        </label>

        <label class="onboarding-field">
          <span>Adresse</span>
          <input type="text" name="address" maxlength="120" [(ngModel)]="profileModalForm.address" />
        </label>

        <label class="onboarding-field">
          <span>Profession *</span>
          <select
            name="profession"
            required
            [(ngModel)]="profileSelectedProfession"
            (ngModelChange)="onProfileProfessionChange($event)">
            <option value="" disabled>Choisis ta profession</option>
            <option *ngFor="let option of professionOptions" [ngValue]="option">{{ option }}</option>
            <option [ngValue]="professionOtherValue">{{ professionOtherValue }}</option>
          </select>
          <input
            *ngIf="profileSelectedProfession === professionOtherValue"
            type="text"
            name="customProfession"
            [(ngModel)]="profileCustomProfession"
            placeholder="Precise ta profession"
            [required]="profileSelectedProfession === professionOtherValue"
            maxlength="60" />
        </label>

        <label class="onboarding-field">
          <span>Date de naissance</span>
          <input type="date" name="birthdate" [(ngModel)]="profileModalForm.birthdate" />
        </label>

        <label class="onboarding-field onboarding-field--full">
          <span>Biographie</span>
          <textarea
            name="bio"
            rows="3"
            maxlength="300"
            [(ngModel)]="profileModalForm.bio"
            placeholder="Présente-toi en quelques lignes…"
          ></textarea>
        </label>
      </div>

      <div class="onboarding-media">
        <div class="onboarding-media__item">
          <p class="onboarding-field__label">Photo de profil (optionnel)</p>
          <div class="onboarding-media__preview">
            <img [src]="profilePhotoPreview || 'assets/icone.png'" alt="Prévisualisation profil" />
          </div>
          <label class="onboarding-media__button">
            Choisir une image
            <input type="file" accept="image/*" (change)="onSelectProfilePhoto($event)" hidden />
          </label>
        </div>
        <div class="onboarding-media__item">
          <p class="onboarding-field__label">Photo de couverture (optionnel)</p>
          <div class="onboarding-media__preview onboarding-media__preview--wide">
            <img [src]="coverPhotoPreview || 'assets/icone.png'" alt="Prévisualisation couverture" />
          </div>
          <label class="onboarding-media__button">
            Choisir une image
            <input type="file" accept="image/*" (change)="onSelectCoverPhoto($event)" hidden />
          </label>
        </div>
      </div>

      <p class="onboarding-modal__error" *ngIf="profileModalError">{{ profileModalError }}</p>

      <button type="submit" class="onboarding-modal__submit" [disabled]="profileModalSaving || profilePseudoStatus === 'checking'">
        {{ profileModalSaving ? 'Enregistrement…' : 'Continuer' }}
      </button>
    </form>
  </div>
</div>

<section class="dashboard">
  <div *ngIf="showProfileWarning" class="dashboard__profile-warning">
    <div>
      <p class="dashboard__profile-warning-title">My rendre</p>
      <p class="dashboard__profile-warning-text">
        Complète tes informations personnelles pour profiter pleinement de Woya.
      </p>
    </div>
    <a routerLink="/mon-compte/infos" class="dashboard__profile-warning-btn">
      Renseigner mes infos
    </a>
  </div>
  <div class="dashboard__layout">
    <div class="dashboard__welcome dashboard__card">
      <p class="dashboard__welcome-label">Bienvenue</p>
      <h1 class="dashboard__welcome-title">

        <ng-container *ngIf="!userLoading; else dashboardNameLoading">

          {{ userName }}

        </ng-container>

      </h1>

      <ng-template #dashboardNameLoading>

        <span class="dashboard__welcome-skeleton" aria-hidden="true"></span>

      </ng-template>

     <p class="dashboard__welcome-subtitle mt-2 -mb-2">
        Retrouve toutes tes actions importantes ici !
      </p>
    </div>
    <div class="dashboard__hero-next dashboard__card">
      <div class="dashboard__appointment-header">
        <p>Prochain rendez-vous </p>
        <span
          class="badge-new"
          *ngIf="nextAppointment"
          [ngClass]="{
            'badge-new--confirmed': nextAppointment.status === 'confirmed',
            'badge-new--pending': nextAppointment.status === 'pending'
          }"
        >
          {{ nextAppointment.status === 'confirmed' ? 'Confirmé' : 'En attente' }}
        </span>
      </div>

      <div class="dashboard__appointment-body" *ngIf="!appointmentLoading; else appointmentLoadingTpl">
        <ng-container *ngIf="nextAppointment; else noAppointmentTpl">
          <div class="dashboard__appointment-cover">
            <img [src]="nextAppointment.coverUrl" alt="Service réservé">
          </div>
          <h2>{{ nextAppointment.title }}</h2>
          <p class="dashboard__appointment-provider" *ngIf="nextAppointment.counterpartName">
            Avec
            <a
              *ngIf="nextAppointment.counterpartLink; else plainName"
              [routerLink]="nextAppointment.counterpartLink"
            >
              {{ nextAppointment.counterpartName }}
            </a>
            <ng-template #plainName>{{ nextAppointment.counterpartName }}</ng-template>
          </p>
          <p class="dashboard__appointment-date">{{ nextAppointment.dateLabel }}</p>
          <p class="dashboard__appointment-role">{{ nextAppointment.roleLabel }}</p>
          <p
            class="dashboard__appointment-tip"
            *ngIf="nextAppointment.status === 'pending'"
          >
            Ta demande est en attente de validation.
          </p>
          <p class="dashboard__appointment-error" *ngIf="cancelNextError">
            {{ cancelNextError }}
          </p>
          <div class="dashboard__appointment-actions" *ngIf="nextAppointment">
            <a class="dashboard__appointment-message" routerLink="/messagerie">
              Contacter le prestataire
            </a>
            <button
              type="button"
              class="dashboard__appointment-link"
              [routerLink]="nextAppointment.route"
            >
              Détail
            </button>
            <button
              type="button"
              class="dashboard__appointment-cancel"
              *ngIf="canCancelNextAppointment"
              (click)="cancelNextAppointment()"
              [disabled]="cancellingNext"
            >
              {{ cancellingNext ? 'Annulation...' : 'Annuler ma réservation' }}
            </button>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <section class="dashboard__actions">
    <h2 class="dashboard__section-title">Accès rapides</h2>
    <div class="dashboard__grid">
      <a
        class="dashboard-card"
        [class.dashboard-card--accent]="action.accent"
        [routerLink]="action.route"
        *ngFor="let action of dashboardActions; trackBy: trackByActionId"
      >
        <span *ngIf="action.badge" class="dashboard-card__badge">{{ action.badge }}</span>
        <div class="dashboard-card__icon" [ngSwitch]="action.icon">
          <svg *ngSwitchCase="'services'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" />
          </svg>
          <svg *ngSwitchCase="'providers'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 19c0-3.31 3.13-6 7-6s7 2.69 7 6" />
          </svg>
          <svg *ngSwitchCase="'my-services'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M7 17h10" />
          </svg>
          <svg *ngSwitchCase="'reservations'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <rect x="3" y="5" width="18" height="16" rx="2" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M8 3v4M16 3v4" />
          </svg>
          <svg *ngSwitchCase="'appointments'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 4h14a2 2 0 0 1 2 2v13l-4-3-4 3-4-3-4 3V6a2 2 0 0 1 2-2Z" />
          </svg>
          <svg *ngSwitchCase="'messages'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 5h16v11H7l-3 3z" />
          </svg>
          <svg *ngSwitchCase="'notifications'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5a4 4 0 0 1 4 4v2.764a2 2 0 0 0 .553 1.382l1.6 1.8A1 1 0 0 1 17.4 16H6.6a1 1 0 0 1-.753-1.654l1.6-1.8A2 2 0 0 0 8 11.764V9a4 4 0 0 1 4-4Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 16a2 2 0 1 0 4 0" />
          </svg>
          <svg *ngSwitchCase="'publish'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14" />
          </svg>
          <svg *ngSwitchDefault xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <circle cx="12" cy="12" r="9" />
          </svg>
        </div>
        <div class="dashboard-card__body">
          <h3>{{ action.title }}</h3>
          <p>{{ action.description }}</p>
        </div>
      </a>
    </div>
  </section>
</section>

<ng-template #appointmentLoadingTpl>
  <div class="dashboard__appointment-loading">
    <div class="spinner"></div>
    <p>Chargement des prochains rendez-vous…</p>
  </div>
</ng-template>

<ng-template #noAppointmentTpl>
  <div class="dashboard__appointment-empty">
    <p>Aucun rendez-vous à venir pour le moment.</p>
    <a routerLink="/services" class="dashboard__appointment-cta">Réserver un service</a>
  </div>
</ng-template>
