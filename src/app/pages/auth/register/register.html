<ng-container *ngIf="!isLoggedIn; else alreadyLoggedRegister">
  <div class="min-h-screen bg-[#FFF7EB] flex items-center justify-center px-4 pt-12 py-8 -mt-10 md:-mt-10">
    <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-lg border">

      <h1 class="text-2xl font-bold text-center text-[#FF7A00] mb-6">
        CrÃ©er un compte
      </h1>

      <!-- Google -->
      <button (click)="loginWithGoogle()"
        class="w-full py-3 border rounded-xl flex justify-center items-center gap-2 hover:bg-gray-50 transition mb-2 ">
        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5" />
        Continuer avec Google
      </button>

  <div class="my-5 text-center text-gray-500 text-sm">ou</div>

      <div *ngIf="error" class="mb-3 text-sm text-red-600 text-center">{{ error }}</div>

      <!-- PrÃ©nom -->
      <input [(ngModel)]="form.firstname" placeholder="PrÃ©nom"
        class="w-full border rounded-xl px-4 py-3 mb-3 outline-none" />

    <!-- Nom -->
    <input [(ngModel)]="form.lastname" placeholder="Nom"
      class="w-full border rounded-xl px-4 py-3 mb-3 outline-none" />

    <!-- Pseudo -->
    <div class="mb-3">
      <input [(ngModel)]="form.pseudo"
             name="registerPseudo"
             (ngModelChange)="onPseudoChange($event)"
             placeholder="Pseudo (visible par la communautÃ©)"
             maxlength="40"
             required
             class="w-full border rounded-xl px-4 py-3 outline-none" />
      <p *ngIf="pseudoStatus !== 'idle'"
         class="text-xs mt-1"
         [ngClass]="{
           'text-gray-500': pseudoStatus === 'checking',
           'text-green-600': pseudoStatus === 'available',
           'text-red-600': pseudoStatus === 'taken',
           'text-orange-600': pseudoStatus === 'error'
         }">
        <ng-container [ngSwitch]="pseudoStatus">
          <span *ngSwitchCase="'checking'">VÃ©rification du pseudoâ€¦</span>
          <span *ngSwitchCase="'available'">Pseudo disponible.</span>
          <span *ngSwitchCase="'taken'">Ce pseudo est dÃ©jÃ  utilisÃ©.</span>
          <span *ngSwitchCase="'error'">Impossible de vÃ©rifier le pseudo.</span>
        </ng-container>
      </p>
    </div>

    <!-- Profession -->
    <select
      [(ngModel)]="selectedProfession"
      name="profession"
      required
      (ngModelChange)="onProfessionSelectChange($event)"
      class="w-full border rounded-xl px-4 py-3 mb-3 outline-none bg-white">
      <option value="" disabled>Choisis ta profession</option>
      <option *ngFor="let option of professionOptions" [ngValue]="option">{{ option }}</option>
      <option [ngValue]="professionOtherValue">{{ professionOtherValue }}</option>
    </select>
    <input *ngIf="selectedProfession === professionOtherValue"
      [(ngModel)]="customProfession"
      name="customProfession"
      placeholder="Precise ta profession"
      [required]="selectedProfession === professionOtherValue"
      maxlength="60"
      class="w-full border rounded-xl px-4 py-3 mb-3 outline-none" />

      <!-- Email -->
      <div class="mb-3">
        <input [(ngModel)]="form.email"
               type="email"
               placeholder="Email"
               class="w-full border rounded-xl px-4 py-3 outline-none"
               (ngModelChange)="onEmailChange($event)" />
        <p *ngIf="emailStatus !== 'idle'"
           class="text-xs mt-1"
           [ngClass]="{
             'text-gray-500': emailStatus === 'checking',
             'text-green-600': emailStatus === 'available',
             'text-red-600': emailStatus === 'taken' || emailStatus === 'invalid',
             'text-orange-600': emailStatus === 'error'
           }">
          <ng-container [ngSwitch]="emailStatus">
            <span *ngSwitchCase="'checking'">VÃ©rification de l'emailâ€¦</span>
            <span *ngSwitchCase="'available'">Adresse disponible.</span>
            <span *ngSwitchCase="'taken'">Cette adresse e-mail est dÃ©jÃ  utilisÃ©e.</span>
            <span *ngSwitchCase="'invalid'">Adresse e-mail invalide.</span>
            <span *ngSwitchCase="'error'">Impossible de vÃ©rifier l'adresse pour le moment.</span>
          </ng-container>
        </p>
      </div>

      <!-- Password -->
      <div class="relative mb-3">
        <input [(ngModel)]="form.password"
               [type]="showPassword ? 'text' : 'password'"
               placeholder="Mot de passe"
               class="w-full border rounded-xl px-4 py-3 pr-12 outline-none"
               (ngModelChange)="onPasswordChange($event)" />
        <button type="button"
                class="absolute inset-y-0 right-3 flex items-center text-gray-500"
                (click)="togglePasswordVisibility('password')">
          <svg *ngIf="!showPassword" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7Z" />
            <circle cx="12" cy="12" r="3" />
          </svg>
          <svg *ngIf="showPassword" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M3 3l18 18M10.584 10.59a1.5 1.5 0 102.827 2.82M7.362 7.37A9.936 9.936 0 001.458 12C2.732 16.057 6.523 19 11 19c1.32 0 2.59-.235 3.766-.666M18.05 14.14c1.748-1.257 3.064-3.028 3.492-5.14A9.956 9.956 0 0013 5c-.835 0-1.65.1-2.431.288" />
          </svg>
        </button>
      </div>

      <div class="bg-[#FFF7EB] border border-[#FFE0BF] rounded-xl px-4 py-3 mb-3 text-sm">
        <p class="text-xs uppercase text-gray-500 tracking-wide mb-2">CritÃ¨res du mot de passe</p>
        <ul class="space-y-1">
          <li class="flex items-center gap-2"
              [ngClass]="passwordCriteria.minLength ? 'text-green-600' : 'text-gray-600'">
            <span class="w-2 h-2 rounded-full"
                  [ngClass]="passwordCriteria.minLength ? 'bg-green-500' : 'bg-gray-300'"></span>
            6 caractÃ¨res minimum
          </li>
          <li class="flex items-center gap-2"
              [ngClass]="passwordCriteria.uppercase ? 'text-green-600' : 'text-gray-600'">
            <span class="w-2 h-2 rounded-full"
                  [ngClass]="passwordCriteria.uppercase ? 'bg-green-500' : 'bg-gray-300'"></span>
            Au moins une lettre majuscule
          </li>
          <li class="flex items-center gap-2"
              [ngClass]="passwordCriteria.digit ? 'text-green-600' : 'text-gray-600'">
            <span class="w-2 h-2 rounded-full"
                  [ngClass]="passwordCriteria.digit ? 'bg-green-500' : 'bg-gray-300'"></span>
            Au moins un chiffre
          </li>
          <li class="flex items-center gap-2"
              [ngClass]="passwordCriteria.special ? 'text-green-600' : 'text-gray-600'">
            <span class="w-2 h-2 rounded-full"
                  [ngClass]="passwordCriteria.special ? 'bg-green-500' : 'bg-gray-300'"></span>
            Au moins un caractÃ¨re spÃ©cial
          </li>
        </ul>
      </div>

      <!-- Confirm Password -->
      <div class="relative mb-1">
        <input [(ngModel)]="confirmPassword"
               [type]="showConfirmPassword ? 'text' : 'password'"
               placeholder="Confirmer le mot de passe"
               class="w-full border rounded-xl px-4 py-3 pr-12 outline-none"
               (ngModelChange)="onConfirmPasswordChange()" />
        <button type="button"
                class="absolute inset-y-0 right-3 flex items-center text-gray-500"
                (click)="togglePasswordVisibility('confirm')">
          <svg *ngIf="!showConfirmPassword" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7Z" />
            <circle cx="12" cy="12" r="3" />
          </svg>
          <svg *ngIf="showConfirmPassword" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M3 3l18 18M10.584 10.59a1.5 1.5 0 102.827 2.82M7.362 7.37A9.936 9.936 0 001.458 12C2.732 16.057 6.523 19 11 19c1.32 0 2.59-.235 3.766-.666M18.05 14.14c1.748-1.257 3.064-3.028 3.492-5.14A9.956 9.956 0 0013 5c-.835 0-1.65.1-2.431.288" />
          </svg>
        </button>
      </div>
      <p *ngIf="confirmPassword"
         class="text-xs mb-3"
         [ngClass]="passwordsMatch ? 'text-green-600' : 'text-red-600'">
        {{ passwordsMatch ? 'Les mots de passe correspondent.' : 'Les mots de passe ne correspondent pas.' }}
      </p>

      <!-- TÃ©lÃ©phone -->
      <div class="flex gap-3 flex-wrap mb-1">
        <select [(ngModel)]="form.countryCode"
                class="border rounded-xl px-3 py-3 outline-none bg-white flex-none"
                (ngModelChange)="onPhoneChange()">
          <option value="+225">ðŸ‡¨ðŸ‡® +225</option>
          <option value="+33">ðŸ‡«ðŸ‡· +33</option>
          <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
        </select>
        <input [(ngModel)]="form.phone"
               placeholder="TÃ©lÃ©phone"
               class="flex-1 border rounded-xl px-4 py-3 outline-none"
               (ngModelChange)="onPhoneChange()" />
      </div>
      <p *ngIf="phoneStatus !== 'idle'"
         class="text-xs mb-3"
         [ngClass]="{
           'text-gray-500': phoneStatus === 'checking',
           'text-green-600': phoneStatus === 'available',
           'text-red-600': phoneStatus === 'taken' || phoneStatus === 'invalid',
           'text-orange-600': phoneStatus === 'error'
         }">
        <ng-container [ngSwitch]="phoneStatus">
          <span *ngSwitchCase="'checking'">VÃ©rification du numÃ©roâ€¦</span>
          <span *ngSwitchCase="'available'">NumÃ©ro disponible.</span>
          <span *ngSwitchCase="'taken'">Ce numÃ©ro est dÃ©jÃ  utilisÃ©.</span>
          <span *ngSwitchCase="'invalid'">NumÃ©ro invalide.</span>
          <span *ngSwitchCase="'error'">Impossible de vÃ©rifier le numÃ©ro pour le moment.</span>
        </ng-container>
      </p>

      <!-- Date de naissance -->
      <div class="relative mb-4">
        <div class="w-full border rounded-xl px-4 py-3 outline-none bg-white cursor-pointer"
             (click)="toggleBirthdatePicker()">
          <p class="text-sm text-gray-500" *ngIf="!form.birthdate">Date de naissance</p>
          <p class="text-base text-[#1A1A1A]" *ngIf="form.birthdate">{{ form.birthdate | date:'dd MMMM yyyy' }}</p>
        </div>
        <div *ngIf="showBirthdatePicker"
             class="absolute z-10 mt-2 w-full rounded-2xl border border-[#FFE0BF] bg-white shadow-lg p-4">
          <input type="date"
                 [(ngModel)]="form.birthdate"
                 class="w-full border rounded-xl px-4 py-3 outline-none"
                 (change)="toggleBirthdatePicker()" />
        </div>
      </div>

      <input [(ngModel)]="form.city" placeholder="Ville"
        class="w-full border rounded-xl px-4 py-3 mb-3 outline-none" />

      <input [(ngModel)]="form.address" placeholder="Adresse complÃ¨te"
        class="w-full border rounded-xl px-4 py-3 mb-4 outline-none" />

      <!-- Submit -->
      <button (click)="register()" [disabled]="loading"
        class="w-full py-3 bg-[#FF7A00] text-white rounded-xl font-semibold hover:bg-[#e66d00] transition disabled:opacity-60 disabled:cursor-not-allowed">
        {{ loading ? 'CrÃ©ation...' : 'CrÃ©er un compte' }}
      </button>

      <p class="text-center text-sm mt-6 text-gray-600">
        DÃ©jÃ  un compte ?
        <a routerLink="/login" class="text-[#FF7A00] font-semibold hover:underline">Se connecter</a>
      </p>

    </div>
  </div>
</ng-container>

<div *ngIf="showProfilePrompt" class="fixed inset-0 bg-black/50 flex items-center justify-center px-4 py-8 z-50">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg p-6 relative">
    <button type="button"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            (click)="showProfilePrompt = false">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
      </svg>
    </button>
    <div class="space-y-2 mb-4">
      <p class="text-xs uppercase tracking-[0.4em] text-[#FF7A00]">Bienvenue</p>
      <h2 class="text-2xl font-semibold text-gray-900">ComplÃ¨te ton profil</h2>
      <p class="text-sm text-gray-500">Renseigne au moins ces informations pour finaliser ton inscription.</p>
    </div>
    <form class="space-y-3" (ngSubmit)="submitProfilePrompt()">
      <input [(ngModel)]="profilePrompt.firstname"
             name="promptFirstName"
             placeholder="PrÃ©nom"
             class="w-full border rounded-2xl px-4 py-3 outline-none" />
      <input [(ngModel)]="profilePrompt.lastname"
             name="promptLastName"
             placeholder="Nom"
             class="w-full border rounded-2xl px-4 py-3 outline-none" />
      <div>
        <input [(ngModel)]="profilePrompt.pseudo"
               (ngModelChange)="onProfilePromptPseudoChange($event)"
               name="promptPseudo"
               placeholder="Pseudo"
               class="w-full border rounded-2xl px-4 py-3 outline-none" />
        <p *ngIf="profilePromptPseudoStatus !== 'idle'"
           class="text-xs mt-1"
           [ngClass]="{
             'text-gray-500': profilePromptPseudoStatus === 'checking',
             'text-green-600': profilePromptPseudoStatus === 'available',
             'text-red-600': profilePromptPseudoStatus === 'taken',
             'text-orange-600': profilePromptPseudoStatus === 'error'
           }">
          <ng-container [ngSwitch]="profilePromptPseudoStatus">
            <span *ngSwitchCase="'checking'">VÃ©rification du pseudoâ€¦</span>
            <span *ngSwitchCase="'available'">Pseudo disponible.</span>
            <span *ngSwitchCase="'taken'">Ce pseudo est dÃ©jÃ  utilisÃ©.</span>
            <span *ngSwitchCase="'error'">Impossible de vÃ©rifier le pseudo.</span>
          </ng-container>
        </p>
      </div>
      <input [(ngModel)]="profilePrompt.phone"
             name="promptPhone"
             placeholder="TÃ©lÃ©phone (optionnel)"
             class="w-full border rounded-2xl px-4 py-3 outline-none" />
      <p *ngIf="profilePromptError" class="text-sm text-red-600">{{ profilePromptError }}</p>
      <button type="submit"
              class="w-full rounded-2xl bg-[#FF7A00] text-white font-semibold py-3"
              [disabled]="loading">
        {{ loading ? 'Enregistrementâ€¦' : 'Valider' }}
      </button>
    </form>
  </div>
</div>

<ng-template #alreadyLoggedRegister>
  <div class="min-h-screen bg-[#FFF7EB] flex items-center justify-center px-4">
    <div class="bg-white w-full max-w-md p-10 rounded-2xl shadow-lg border text-center space-y-4">
      <p class="text-lg font-semibold text-[#1A1A1A]">Tu es dÃ©jÃ  connectÃ©.</p>
      <a routerLink="/services"
         class="inline-flex items-center justify-center rounded-full border border-[#FF7A00] px-5 py-2 text-sm font-semibold text-[#FF7A00] hover:bg-[#FF7A00] hover:text-white transition">
        Retour aux services
      </a>
    </div>
  </div>
</ng-template>
