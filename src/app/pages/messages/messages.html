<section class="min-h-screen bg-[#FFF7EB] pt-10 md:pt-28 pb-16 px-4 md:px-16">
  <div class="max-w-5xl -mt20 mx-auto">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-10">
      <div>
        <p class="text-sm uppercase tracking-[0.35em] text-[#FFB066]">Messagerie</p>
        <h1 class="text-3xl font-bold text-[#1A1A1A] mt-1">Boîte de réception</h1>
        <p class="text-sm text-gray-600 mt-2">
          Retrouvez ici toutes vos conversations avec les prestataires et clients.
        </p>
      </div>
    </header>

    

    <div class="bg-white/90 backdrop-blur rounded-3xl border border-[#FFE0BF] shadow-sm">
      <div *ngIf="loading" class="py-14 flex items-center justify-center text-gray-500">
        Chargement de vos conversations…
      </div>

      <ng-container *ngIf="!loading">
        <div class="px-6 py-4 border-b border-[#FFE0BF] flex flex-col gap-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3" *ngIf="conversations.length">
            <div class="relative flex-1">
              <input type="text"
                     [(ngModel)]="searchTerm"
                     placeholder="Rechercher dans vos conversations"
                     class="w-full rounded-2xl border border-[#FFE0BF] px-4 py-2 outline-none text-sm text-gray-700 focus:ring-2 focus:ring-[#FF7A00]/40" />
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[#FF7A00] text-xs font-semibold">
                {{ filteredConversations.length }}/{{ conversations.length }}
              </span>
            </div>
            <p class="text-xs text-gray-500 text-center md:text-right" *ngIf="conversations.length && conversations[0].conversation.updatedAt">
              Dernière maj {{ conversations[0].conversation.updatedAt | timeAgo }}
            </p>
          </div>

          <div class="relative">
            <label class="block text-xs text-gray-500 font-semibold mb-1">Contacter un prestataire</label>
            <input type="text"
                   [value]="newContactTerm"
                   (input)="onNewContactInput($event.target.value)"
                   placeholder="Saisis un nom ou un métier"
                   class="w-full rounded-2xl border border-[#FFE0BF] px-4 py-2 outline-none text-sm text-gray-700 focus:ring-2 focus:ring-[#FF7A00]/40" />
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-400" *ngIf="newContactLoading">
              Recherche…
            </div>
            <div class="mt-2 border border-[#FFE0BF] rounded-2xl bg-white shadow-sm divide-y divide-[#FFE0BF]"
                 *ngIf="newContactResults.length">
              <button type="button"
                      class="w-full flex items-center gap-3 px-4 py-2 text-left hover:bg-[#FFF4E6] transition"
                      *ngFor="let result of newContactResults"
                      (click)="startConversationWith(result)">
                <img [src]="result.photoURL || 'assets/icone.png'"
                     class="w-10 h-10 rounded-full border border-[#FFE0BF] object-cover"
                     alt="Avatar prestataire">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-[#1A1A1A]">{{ displayName(result) }}</p>
                  <p class="text-xs text-gray-500">{{ result.profession || result.city || 'Prestataire Woya' }}</p>
                </div>
                <span class="text-xs font-semibold text-[#FF7A00]">Contacter</span>
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="!conversations.length" class="py-16 flex flex-col items-center justify-center text-center gap-3">
          <img src="assets/icone.png" alt="Messagerie vide" class="w-20 h-20 opacity-80 rounded-full border border-[#FFE0BF] object-cover" />
          <p class="text-lg font-semibold text-[#1A1A1A]">Aucune conversation pour le moment</p>
          <p class="text-sm text-gray-500 max-w-md">
            Consultez un service et cliquez sur « Contacter par messagerie » pour démarrer un échange sécurisé.
          </p>
        </div>

        <div *ngIf="conversations.length && !filteredConversations.length" class="py-10 text-center text-sm text-gray-500">
          Aucun résultat pour « {{ searchTerm }} ».
        </div>

        <div *ngIf="filteredConversations.length" class="max-h-[32rem] overflow-y-auto" (scroll)="onScroll($event)">
        <ul class="divide-y divide-[#FFE0BF]">
          <li *ngFor="let item of visibleConversations" (click)="open(item.conversation)" class="cursor-pointer px-6 py-5 hover:bg-[#FFF4E6] transition">
            <div class="flex gap-4 items-start">
              <button type="button"
                      class="focus:outline-none"
                      (click)="goToProfile(item, $event)">
                <img [src]="item.otherUser?.photoURL || 'assets/icone.png'" alt="Avatar" class="w-12 h-12 rounded-full object-cover border border-[#FFE0BF]" />
              </button>
              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <button type="button"
                          (click)="goToProfile(item, $event)"
                          class="font-semibold text-[#1A1A1A] text-base truncate text-left hover:text-[#FF7A00] focus:outline-none">
                    {{ displayName(item.otherUser) }}
                  </button>
                  <span *ngIf="item.unread" class="px-2 py-0.5 text-xs rounded-full bg-[#FF7A00] text-white uppercase tracking-wide">Nouveau</span>
                </div>
                <p class="text-xs text-gray-500" *ngIf="item.otherUser?.pseudo && (item.otherUser?.firstname || item.otherUser?.lastname)">
                  {{ item.otherUser?.firstname }} {{ item.otherUser?.lastname }}
                </p>
                <p class="text-xs text-gray-500" *ngIf="item.otherUser?.profession">
                  {{ item.otherUser.profession }}
                </p>

                <p class="text-sm text-gray-600 truncate mt-1">
                  {{ item.conversation.lastMessage?.body || 'Aucun message pour le moment' }}
                </p>

                <div class="mt-3 flex flex-wrap gap-4 text-xs text-gray-500">
                  <span *ngIf="item.conversation.updatedAt">Mis à jour {{ item.conversation.updatedAt | timeAgo }}</span>
                  <span *ngIf="item.otherUser?.lastSeen">Dernière connexion {{ item.otherUser.lastSeen | timeAgo }}</span>
                </div>
              </div>
            </div>
          </li>
        </ul>
        </div>
      </ng-container>
    </div>
  </div>
</section>
