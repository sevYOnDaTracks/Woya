<section class="min-h-screen bg-[#FFF7EB] pt-4 pb-16 px-4">
  <div class="max-w-5xl mx-auto space-y-8">
    <div class="glass-card flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="hero-eyebrow">Mes réservations</p>
       <!-- <h1 class="hero-title text-2xl md:text-3xl">Suivre mes rendez-vous</h1> --> 
      <!-- <p class="text-sm text-gray-500 mb-2 mt-2">Visualise tous les créneaux demandés auprès des prestataires et contacte-les facilement.</p> --> 
      </div>
      <div class="flex gap-2 rounded-2xl border border-[#FFE0BF] bg-white p-1 w-full max-w-md">
        <button type="button"
                class="tab-pill"
                [class.tab-pill--active]="view === 'upcoming'"
                (click)="switchView('upcoming')">
          À venir
        </button>
        <button type="button"
                class="tab-pill"
                [class.tab-pill--active]="view === 'history'"
                (click)="switchView('history')">
          Historique
        </button>
      </div>
    </div>

    <div class="glass-card flex flex-col gap-4" *ngIf="!loading">
      <div class="filters">
        <div class="filter-field">
          <label>Statut</label>
          <select [(ngModel)]="statusFilter" class="filter-control">
            <option value="all">Tous</option>
            <option value="pending">En attente</option>
            <option value="confirmed">Confirmés</option>
            <option value="cancelled">Annulés</option>
          </select>
        </div>
      <!-- <div class="filter-field">
          <label>Service</label>
          <input type="text"
                 [(ngModel)]="serviceFilter"
                 placeholder="Rechercher un service"
                 class="filter-control" />
        </div> --> 
        <div class="filter-field">
          <label>Recherche</label>
          <input type="text"
                 [(ngModel)]="searchTerm"
                 placeholder="Prestataire ou service"
                 class="filter-control" />
        </div>
      </div>
    </div>

    <div *ngIf="loading" class="glass-card flex flex-col items-center gap-3 text-center mt-6">
      <div class="animate-spin h-10 w-10 border-4 border-[#FF7A00] border-t-transparent rounded-full"></div>
      <p class="text-sm text-gray-500">Chargement de tes réservations…</p>
    </div>

    <p *ngIf="error" class="text-sm text-red-500 text-center">{{ error }}</p>

    <ng-container *ngIf="!loading">
      <ng-container *ngIf="filteredBookings.length; else emptyState">
        <ng-container *ngIf="bookingsForSelectedDate as dayBookings">
          <div class="calendar-layout">
            <div class="glass-card calendar-panel">
              <div class="calendar-panel__header">
                <div>
                  <p class="calendar-panel__eyebrow">Le {{ selectedDateLabel }}</p>
                  <h2 class="calendar-panel__title">
                    {{ dayBookings.length ? (dayBookings.length === 1 ? '1 rendez-vous prévu' : dayBookings.length + ' rendez-vous prévus') : 'Pas de rendez-vous' }}
                  </h2>
                  <p class="calendar-panel__subtitle">
                    {{ dayBookings.length ? 'Garde un œil sur tes échanges avec les prestataires.' : 'Choisis une date pour revoir tes réservations.' }}
                  </p>
                </div>
                <a class="primary-btn calendar-panel__cta"
                   routerLink="/services">
                  Trouver un service
                </a>
              </div>

              <div *ngIf="dayBookings.length; else emptySelectedDate" class="space-y-4">
                <article *ngFor="let booking of dayBookings"
                         class="booking-card">
                  <div class="booking-card__header">
                    <div class="booking-card__time-block">
                      <span class="booking-card__time">
                        {{ booking.startTime | date:'HH:mm':'':'fr-FR' }}
                      </span>
                      <div>
                        <p class="booking-card__title">{{ booking.serviceTitle }}</p>
                        <p class="booking-card__subtitle">
                          {{ providerName(booking) }}
                        </p>
                      </div>
                    </div>
                    <span [class]="statusBadgeClass(booking.status)">
                      {{ booking.status === 'pending' ? 'En attente' : (booking.status === 'confirmed' ? 'Confirmé' : 'Annulé') }}
                    </span>
                  </div>

                  <div class="booking-card__body">
                    <p class="text-sm text-gray-600 flex items-center gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7.5A2.5 2.5 0 0 0 18.5 5h-13A2.5 2.5 0 0 0 3 7.5V19a2 2 0 0 0 2 2Z" />
                      </svg>
                      {{ booking.startTime | date:'EEEE d MMMM • HH:mm':'':'fr-FR' }}
                    </p>
                    <p class="text-sm text-gray-600 flex items-center gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 7.5 12 12l7.5-4.5M4.5 12l7.5 4.5 7.5-4.5M4.5 16.5 12 21l7.5-4.5" />
                      </svg>
                      <a [routerLink]="providerProfileLink(booking)"
                         class="booking-link">
                        {{ providerName(booking) }}
                      </a>
                    </p>
                    <p class="text-xs text-gray-500" *ngIf="booking.createdAt">
                      Demande envoyée {{ booking.createdAt | timeAgo }}
                    </p>
                  </div>

                  <div class="booking-card__actions">
                    <button type="button"
                            class="secondary-btn"
                            [routerLink]="['/services', booking.serviceId]">
                      Voir l'annonce
                    </button>
                    <button type="button"
                            class="icon-btn"
                            [disabled]="contactingId === (booking.id || booking.serviceId)"
                            (click)="contactProvider(booking)">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5A2.5 2.5 0 0 1 5.5 5h13A2.5 2.5 0 0 1 21 7.5v9a2.5 2.5 0 0 1-2.5 2.5h-13A2.5 2.5 0 0 1 3 16.5v-9Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="m3 8 8.4 6.3a1 1 0 0 0 1.2 0L21 8" />
                      </svg>
                    </button>
                  </div>
                </article>
              </div>

              <ng-template #emptySelectedDate>
                <div class="calendar-panel__empty">
                  <p class="text-base font-semibold text-[#1A1A1A]">Aucun rendez-vous ce jour.</p>
                  <p class="text-sm text-gray-500">Sélectionne une autre date pour revoir tes demandes.</p>
                </div>
              </ng-template>
            </div>

            <div class="glass-card calendar-shell">
              <div class="calendar-shell__header">
                <button type="button"
                        class="calendar-nav-btn"
                        (click)="changeMonth(-1)"
                        aria-label="Mois précédent">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="20"
                       height="20"
                       viewBox="0 0 24 24"
                       fill="none"
                       focusable="false"
                       aria-hidden="true">
                    <path d="m15 19-7-7 7-7"
                          stroke="#FF7A00"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round" />
                  </svg>
                </button>
                <div>
                  <p class="calendar-shell__eyebrow">Calendrier</p>
                  <p class="calendar-shell__title">{{ monthLabel }}</p>
                </div>
                <button type="button"
                        class="calendar-nav-btn"
                        (click)="changeMonth(1)"
                        aria-label="Mois suivant">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="20"
                       height="20"
                       viewBox="0 0 24 24"
                       fill="none"
                       focusable="false"
                       aria-hidden="true">
                    <path d="m9 5 7 7-7 7"
                          stroke="#FF7A00"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round" />
                  </svg>
                </button>
              </div>

              <div class="calendar-weekdays">
                <span *ngFor="let weekday of weekDays">{{ weekday }}</span>
              </div>

              <div class="calendar-grid">
                <div *ngFor="let week of calendarWeeks" class="calendar-week">
                  <button type="button"
                          *ngFor="let day of week"
                          class="calendar-day"
                          [class.calendar-day--outside]="!day.inCurrentMonth"
                          [class.calendar-day--selected]="day.timestamp === activeDate"
                          [class.calendar-day--today]="day.isToday"
                          (click)="selectDate(day.timestamp)">
                    <span>{{ day.label }}</span>
                    <span *ngIf="day.count" class="calendar-day__badge">
                      {{ day.count }}
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <ng-template #emptyState>
        <div class="glass-card text-center">
          <p class="text-lg font-semibold text-[#1A1A1A] mb-2">
            Tu n'as pas encore réservé de créneau {{ view === 'history' ? 'confirmé' : '' }}.
          </p>
          <p class="text-sm text-gray-500">
            Explore les services disponibles pour demander un rendez-vous.
          </p>
          <button routerLink="/services" class="primary-btn mt-4">Explorer les services</button>
        </div>
      </ng-template>
    </ng-container>
  </div>
</section>
