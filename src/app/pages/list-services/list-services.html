<div class="min-h-screen bg-[#FFF7EB] px-4 md:px-16 py-6">

  <!-- SPINNER INIT -->
  <div *ngIf="loading" class="flex justify-center items-center py-24">
    <div class="animate-spin h-28 w-28 border-4 border-[#FF7A00] border-t-transparent rounded-full"></div>
  </div>

  <!-- SEARCH BAR -->
  <div *ngIf="!loading" class="bg-white rounded-2xl p-4 shadow-sm mb-6 flex flex-col gap-4">
    <header class="text-center sm:text-left">
      <p class="text-xs uppercase tracking-[0.3em] text-[#FF7A00] font-semibold">Trouver un service</p>
      <h1 class="text-2xl font-bold text-[#1A1A1A] mt-1">Affinez votre recherche pour d√©couvrir les meilleures offres</h1>
    </header>
    <div class="flex flex-col md:flex-row gap-3 w-full">
      <select [(ngModel)]="category"
              (ngModelChange)="onCategoryChange()"
              class="border rounded-xl px-4 py-3 md:w-64">
        <option *ngFor="let c of categoryOptions" [value]="c">{{ c }}</option>
      </select>

      <div class="flex-1 relative">
        <input [(ngModel)]="serviceTitle"
               (ngModelChange)="onServiceTitleChange()"
               [attr.list]="titleListId"
               type="text"
               placeholder="Rechercher un service"
               class="w-full border rounded-xl px-4 py-3 outline-none" />
        <datalist [attr.id]="titleListId">
          <option *ngFor="let title of titleSuggestions" [value]="title"></option>
        </datalist>
      </div>
    </div>

    <div class="rounded-2xl border border-[#FFE0BF] bg-[#FFF9F2] px-4 py-4 space-y-3">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-sm font-semibold text-[#1A1A1A]">Filtrer par proximit√©</p>
          <p class="text-xs text-gray-500">Affiche uniquement les services qui couvrent ton p√©rim√®tre.</p>
          <p *ngIf="locationError" class="text-xs text-red-500 mt-1">{{ locationError }}</p>
        </div>
        <label class="inline-flex items-center gap-3 text-sm font-semibold text-[#1A1A1A]">
          <span>Afficher uniquement les services qui me couvrent</span>
          <span class="relative inline-flex items-center" [class.opacity-50]="locating">
            <input type="checkbox"
                   class="sr-only peer"
                   [(ngModel)]="limitToCoverage"
                   (change)="onCoverageToggle()"
                   [disabled]="locating">
            <span class="block w-11 h-6 rounded-full bg-gray-300 peer-checked:bg-[#FF7A00] transition-colors"></span>
            <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"></span>
          </span>
        </label>
      </div>
      <p *ngIf="locating" class="text-xs text-gray-500 text-right">Localisation en cours...</p>
    </div>

    <p class="text-right text-sm text-gray-500">
      {{ pendingCount }} elements trouves, veuillez ajuster le filtre pour une recherche plus appropriee.
    </p>
  </div>

  <!-- GRID -->
  <div *ngIf="!loading && filtered.length > 0"
       class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">

    <article *ngFor="let s of filtered"
             class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition flex flex-col h-full">

      <!-- IMAGE + NAV -->
      <div class="relative h-40 rounded-t-2xl overflow-hidden cursor-pointer select-none"
           (click)="goToDetails(s.id!)">

        <img [src]="getCurrentImage(s)"
             class="w-full h-full object-cover transition-transform duration-200"
             [style.transform]="'translateX(' + (translateX[s.id!] || 0) + 'px)'"
             (touchstart)="onTouchStart(s, $event)"
             (touchmove)="onTouchMove(s, $event)"
             (touchend)="onTouchEnd(s)" />

        <button *ngIf="getImages(s).length > 1"
                (click)="prevImage(s, $event)"
                class="absolute top-1/2 left-2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white rounded-full w-6 h-6 flex items-center justify-center backdrop-blur-sm">
          ‚Üê
        </button>

        <button *ngIf="getImages(s).length > 1"
                (click)="nextImage(s, $event)"
                class="absolute top-1/2 right-2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white rounded-full w-6 h-6 flex items-center justify-center backdrop-blur-sm">
          ‚Üí
        </button>

      </div>

      <!-- CONTENT -->
      <div class="p-4 flex flex-col flex-1 justify-between">
        <div class="flex flex-col gap-1">
          <span class="self-end text-xs px-2 py-1 rounded-lg bg-[#FFF7EB] text-[#FF7A00] whitespace-nowrap">
            {{ s.category }}
          </span>
          <h3 class="font-bold text-sm md:text-base text-[#1A1A1A] line-clamp-1 leading-snug mt-1">
            {{ s.title }}
          </h3>
        </div>
        <p class="text-[11px] text-gray-500 mt-1 tracking-tight" *ngIf="s.ownerId">
          Post√© par
          <button type="button"
                  class="font-semibold text-[#FF7A00] underline-offset-2 hover:underline"
                  (click)="viewOwnerProfile($event, s)">
            {{ getOwnerName(s) }}
          </button>
        </p>

       <!--  <p class="text-gray-600 mt-2 line-clamp-2">{{ s.description }}</p> -->

        <div class="mt-3 flex items-center justify-between text-sm text-gray-700">
          <span>üìç {{ s.city }}</span>
          <span class="font-semibold">{{ formatPrice(s) }}</span>
        </div>

        <p *ngIf="s.createdAt" class="text-xs text-gray-400 mt-1">
          Publi√© {{ s.createdAt | timeAgo }}
        </p>


        <div class="mt-4 flex flex-col gap-2 sm:flex-row">
          <a (click)="goToDetails(s.id!)" class="flex-1 flex items-center justify-center px-3 py-2 rounded-xl border border-[#FF7A00] text-[#FF7A00] hover:bg-[#FF7A00] hover:text-white transition">
            Voir +
          </a>
          <button type="button"
                  class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-[#1A1A1A]/20 text-[#1A1A1A] hover:bg-[#1A1A1A]/90 hover:text-white transition"
                  (click)="contactOwner($event, s)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4" fill="currentColor">
              <path d="M2.25 6.75A2.25 2.25 0 0 1 4.5 4.5h15a2.25 2.25 0 0 1 2.25 2.25v10.5A2.25 2.25 0 0 1 19.5 19.5h-15a2.25 2.25 0 0 1-2.25-2.25V6.75Zm2.7-.75a.75.75 0 0 0-.45 1.35l7.05 5.29a.75.75 0 0 0 .9 0l7.05-5.29a.75.75 0 0 0-.45-1.35H4.95Z"/>
            </svg>
            Messagerie
          </button>
        </div>
      </div>

    </article>
  </div>

  <!-- NO RESULT -->
  <div *ngIf="!loading && filteredAll.length === 0"
       class="text-center text-gray-600 mt-10 text-sm">
    Aucun service trouv√© ü•≤
  </div>

  <!-- SPINNER LOAD MORE -->
  <div *ngIf="loadingMore" class="flex justify-center py-8">
    <div class="animate-spin h-24 w-24 border-4 border-[#FF7A00] border-t-transparent rounded-full"></div>
  </div>

</div>
